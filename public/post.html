<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文章详情 - 大古的小站</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .layout {
      max-width: 760px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    a {
      color: #38bdf8;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    header {
      margin-bottom: 24px;
    }

    header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    header p {
      font-size: 13px;
      color: #9ca3af;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 18px 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      margin-bottom: 16px;
    }

    .post-title {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .post-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .post-content {
      font-size: 15px;
    }
  </style>
</head>

<body>
  <div class="layout">
    <header>
      <a href="/">← 回到首页</a>
    </header>

    <div class="card">
      <div id="loading">加载中…</div>
      <h1 class="post-title" id="post-title"></h1>
      <div class="post-meta" id="post-meta"></div>

      <!-- 封面图 + 媒体区域 -->
      <div id="media-area" style="margin: 16px 0;"></div>

      <div class="post-content" id="post-content"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://todo-backend-alpha-henna.vercel.app';



    // ===== 内容格式处理（加粗、换行、超链接） =====
    function formatContent(text) {
      if (!text) return '';

      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // **加粗**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // [文字](链接)
      html = html.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      // 换行
      html = html.replace(/\r?\n/g, '<br>');

      return html;
    }

    // ===== 取 URL 参数（id）=====
    function getPostIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // ===== 加载文章 =====
    async function loadPost() {
      const id = getPostIdFromUrl();

      const loadingEl = document.getElementById('loading');
      const titleEl = document.getElementById('post-title');
      const metaEl = document.getElementById('post-meta');
      const contentEl = document.getElementById('post-content');
      const mediaArea = document.getElementById('media-area');

      if (!id) {
        loadingEl.textContent = '没有找到文章 ID';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/posts/${id}`);
        if (res.status === 404) {
          loadingEl.textContent = '这篇文章不存在，可能被删掉了～';
          return;
        }
        if (!res.ok) {
          loadingEl.textContent = '文章加载失败';
          return;
        }

        const post = await res.json();

        loadingEl.style.display = 'none';

        titleEl.textContent = post.title || '无标题';
        document.title = (post.title || '无标题') + ' - 大古的小站';

        metaEl.textContent = post.createdAt
          ? new Date(post.createdAt).toLocaleString('zh-CN')
          : '';

        // ===== 内容格式化 =====
        contentEl.innerHTML = formatContent(post.content || '');

        // ===== 媒体区域 =====
        mediaArea.innerHTML = '';

        // 封面图
        if (post.coverImage) {
          const img = document.createElement('img');
          img.src = post.coverImage;
          img.style.maxWidth = '100%';
          img.style.borderRadius = '12px';
          img.style.marginBottom = '16px';
          img.onerror = () => img.remove();
          mediaArea.appendChild(img);
        }

        // 媒体列表（图片 / 视频 / 音频）
        if (Array.isArray(post.media)) {
          post.media.forEach(m => {
            if (!m.url) return;

            if (m.type === 'image') {
              const img = document.createElement('img');
              img.src = m.url;
              img.style.maxWidth = '100%';
              img.style.borderRadius = '12px';
              img.style.margin = '12px 0';
              img.onerror = () => img.remove();
              mediaArea.appendChild(img);
            }

            if (m.type === 'video') {
              const video = document.createElement('video');
              video.src = m.url;
              video.controls = true;
              video.style.maxWidth = '100%';
              video.style.margin = '12px 0';
              mediaArea.appendChild(video);
            }

            if (m.type === 'audio') {
              const audio = document.createElement('audio');
              audio.src = m.url;
              audio.controls = true;
              audio.style.width = '100%';
              audio.style.margin = '12px 0';
              mediaArea.appendChild(audio);
            }
          });
        }

      } catch (err) {
        console.error(err);
        loadingEl.textContent = '加载出错';
      }
    }

    loadPost();
  </script>
</body>

</html>