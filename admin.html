<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å†™æ–‡ç«  - å¤§å¤çš„å°ç«™</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .layout {
      max-width: 760px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    a {
      color: #38bdf8;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    header {
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 22px;
    }

    .tag {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(56, 189, 248, 0.15);
      color: #38bdf8;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 18px 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      margin-bottom: 12px;
    }

    textarea {
      min-height: 160px;
      resize: vertical;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      margin-bottom: 14px;
    }

    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: linear-gradient(to right, #38bdf8, #6366f1);
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: #9ca3af;
    }

    .media-item {
      font-size: 13px;
      color: #cbd5f5;
      margin-bottom: 4px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(55, 65, 81, 0.9);
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div class="layout">
    <header>
      <div>
        <h1>å†™ä¸€ç¯‡æ–°æ–‡ç« </h1>
        <div class="hint">é€šè¿‡æ¥å£ç›´æ¥å†™åˆ° MongoDB Â· åªæœ‰ä½ è‡ªå·±çŸ¥é“ç®¡ç†å¯†é’¥ ğŸ˜</div>
      </div>
      <a href="/" class="tag">â† å›åˆ°é¦–é¡µ</a>
    </header>

    <div class="card">
      <form id="post-form">
        <label for="title">æ ‡é¢˜</label>
        <input id="title" type="text" placeholder="æ¯”å¦‚ï¼šåœ¨ shidagu.online ä¸Šå†™çš„ç¬¬äºŒç¯‡æ–‡ç« " required />

        <label for="content">å†…å®¹</label>
        <textarea id="content" placeholder="éšä¾¿å†™ç‚¹ä»Šå¤©çš„æƒ³æ³• / ç¬”è®° / å¿ƒæƒ…..." required></textarea>

        <label for="tags">æ ‡ç­¾ï¼ˆè‹±æ–‡é€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰</label>
        <input id="tags" type="text" placeholder="æ¯”å¦‚ï¼šdiary, note" />

        <label for="cover">å°é¢å›¾ URLï¼ˆå¯é€‰ï¼‰</label>
        <input id="cover" type="url" placeholder="https://example.com/a.jpg" />
        <div class="hint">ä¹Ÿå¯ä»¥ç•™ç©ºï¼Œä¸å†™å°é¢ã€‚</div>

        <hr style="border:none;border-top:1px dashed rgba(148,163,184,0.4);margin:16px 0;">

        <label>åª’ä½“åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</label>
        <div class="hint">
          æ¯ä¸ªåª’ä½“å¯ä»¥æ˜¯ å›¾ç‰‡ / è§†é¢‘ / éŸ³é¢‘ï¼Œå¯¹åº”ä¸€ä¸ª URLã€‚<br>
          ä½ å¯ä»¥ï¼š<br>
          Â· å…ˆæŠŠæ–‡ä»¶ä¼ åˆ°å›¾åºŠ / ç½‘ç›˜ï¼ˆæ¯”å¦‚ Cloudinaryã€Imgur ç­‰ï¼‰ï¼Œç„¶åæŠŠé“¾æ¥å¡«è¿›æ¥ã€‚<br>
          Â· æˆ–è€…ç”¨ä¸‹é¢çš„ã€Œä»æœ¬åœ°é€‰æ‹©æ–‡ä»¶ã€æŒ‰é’®ï¼ŒæŠŠæ–‡ä»¶è¯»æˆ data URL ç›´æ¥ä¿å­˜åˆ°æ–‡ç« é‡Œï¼ˆå›¾ç‰‡ä¸è¦å¤ªå¤§ï¼Œå»ºè®® &lt; 2MBï¼‰ã€‚
        </div>

        <!-- æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªåª’ä½“ï¼ˆçº¯ URLï¼‰ -->
        <div style="margin-bottom: 10px;">
          <select id="manual-media-type">
            <option value="image">å›¾ç‰‡</option>
            <option value="video">è§†é¢‘</option>
            <option value="audio">éŸ³é¢‘</option>
          </select>
          <input id="manual-media-url" type="url" placeholder="https://ä½ çš„æ–‡ä»¶é“¾æ¥" style="width:55%;margin-left:6px;">
          <button type="button" id="add-media-btn" style="margin-left:6px;">+ æ·»åŠ ä¸€ä¸ªåª’ä½“</button>
        </div>

        <!-- ä»æœ¬åœ°é€‰æ‹©æ–‡ä»¶ï¼Œè½¬æˆ data URL -->
        <div style="margin-bottom: 12px;">
          <input id="local-file" type="file" accept="image/*,audio/*,video/*" />
          <button type="button" id="read-local-btn" style="margin-left:6px;">è¯»å–æœ¬åœ°æ–‡ä»¶å¹¶æ·»åŠ </button>
          <div class="hint">é€‰æ‹©ä¸€å¼ å›¾ç‰‡/éŸ³é¢‘/è§†é¢‘ï¼Œæœ¬åœ°è¯»å–åè‡ªåŠ¨åŠ å…¥åª’ä½“åˆ—è¡¨ï¼ˆä¸ä¼šä¸Šä¼ åˆ°ç¬¬ä¸‰æ–¹ï¼Œåªä¿å­˜åˆ°è‡ªå·±çš„æ•°æ®åº“ï¼‰ã€‚</div>
        </div>

        <!-- å½“å‰åª’ä½“åˆ—è¡¨é¢„è§ˆ -->
        <div id="media-list" style="margin-top:8px;margin-bottom:12px;font-size:13px;color:#e5e7eb;">
          å½“å‰è¿˜æ²¡æœ‰åª’ä½“ï¼Œä½ å¯ä»¥æ·»åŠ  URL æˆ–è€…è¯»å–æœ¬åœ°æ–‡ä»¶ã€‚
        </div>

        <button type="submit" id="submit-btn">å‘å¸ƒ</button>
        <div class="status" id="status"></div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api';


    // å½“å‰é¡µé¢çš„ç®¡ç†å¯†é’¥ï¼ˆåªå­˜åœ¨å†…å­˜é‡Œï¼‰
    let adminKey = '';

    (function askAdminKey() {
      const input = prompt('è¯·è¾“å…¥ç®¡ç†å¯†é’¥ï¼ˆç”¨äºå‘æ–‡ç« ï¼‰ï¼š');
      if (!input) {
        alert('å¿…é¡»è¾“å…¥ç®¡ç†å¯†é’¥æ‰èƒ½å‘æ–‡ç« ');
        document.body.innerHTML = '<h2 style="text-align:center;margin-top:40px;">æ— æƒé™è®¿é—®</h2>';
        throw new Error('no admin key');
      }
      adminKey = input;
    })();

    const form = document.getElementById('post-form');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const mediaListEl = document.getElementById('media-list');

    // åœ¨å†…å­˜é‡Œç»´æŠ¤ä¸€ä¸ªåª’ä½“æ•°ç»„
    const mediaList = [];

    function renderMediaList() {
      if (mediaList.length === 0) {
        mediaListEl.textContent = 'å½“å‰è¿˜æ²¡æœ‰åª’ä½“ï¼Œä½ å¯ä»¥æ·»åŠ  URL æˆ–è€…è¯»å–æœ¬åœ°æ–‡ä»¶ã€‚';
        return;
      }
      mediaListEl.innerHTML = '';
      mediaList.forEach((m, idx) => {
        const div = document.createElement('div');
        div.className = 'media-item';
        div.innerHTML = `
          <span class="pill">${m.type}</span>
          <span>${m.url.slice(0, 80)}${m.url.length > 80 ? '...' : ''}</span>
          <button type="button" data-idx="${idx}" style="margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:none;cursor:pointer;">åˆ é™¤</button>
        `;
        mediaListEl.appendChild(div);
      });

      // ç»‘å®šåˆ é™¤æŒ‰é’®
      mediaListEl.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.getAttribute('data-idx'), 10);
          mediaList.splice(i, 1);
          renderMediaList();
        };
      });
    }

    // æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªåª’ä½“ï¼ˆURLï¼‰
    document.getElementById('add-media-btn').addEventListener('click', () => {
      const type = document.getElementById('manual-media-type').value;
      const url = document.getElementById('manual-media-url').value.trim();
      if (!url) {
        alert('è¯·è¾“å…¥åª’ä½“çš„ URL');
        return;
      }
      if (mediaList.length >= 10) {
        alert('åª’ä½“æœ€å¤šåªèƒ½æ·»åŠ  10 ä¸ª');
        return;
      }
      mediaList.push({ type, url });
      document.getElementById('manual-media-url').value = '';
      renderMediaList();
    });

    // ä»æœ¬åœ°è¯»æ–‡ä»¶ â†’ è½¬æˆ data URL â†’ åŠ è¿› mediaList
    document.getElementById('read-local-btn').addEventListener('click', () => {
      const fileInput = document.getElementById('local-file');
      const file = fileInput.files[0];
      if (!file) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
        return;
      }

      // ç®€å•é™åˆ¶ä¸€ä¸‹å¤§å°ï¼Œé¿å…æŠŠè¶…å¤§æ–‡ä»¶å¡è¿›æ•°æ®åº“
      if (file.size > 1024 * 1024 * 2) { // 2MB
        alert('æ–‡ä»¶å¤ªå¤§äº†ï¼Œå»ºè®®æ§åˆ¶åœ¨ 2MB ä»¥å†…');
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result; // ä¾‹å¦‚ data:image/png;base64,xxxx
        let type = 'image';
        if (file.type.startsWith('video/')) type = 'video';
        if (file.type.startsWith('audio/')) type = 'audio';

        mediaList.push({ type, url: dataUrl });
        renderMediaList();
        fileInput.value = '';
      };
      reader.onerror = () => {
        alert('è¯»å–æ–‡ä»¶å¤±è´¥');
      };
      reader.readAsDataURL(file);
    });

    // æäº¤æ–‡ç« 
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const tagsRaw = document.getElementById('tags').value.trim();
      const coverImage = document.getElementById('cover').value.trim();

      if (!title || !content) {
        statusEl.textContent = 'æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º';
        return;
      }

      const tags = tagsRaw
        ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean).map(t => t.slice(0, 30))
        : [];

      submitBtn.disabled = true;
      statusEl.textContent = 'æ­£åœ¨å‘å¸ƒä¸­â€¦';

      try {
        const res = await fetch(`${API_BASE}/posts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey,
          },
          body: JSON.stringify({
            title,
            content,
            tags,
            coverImage,
            media: mediaList,
          }),
        });

        const data = await res.json();

        if (!res.ok) {
          console.log(data);
          statusEl.textContent = data.message || 'å‘å¸ƒå¤±è´¥';
          submitBtn.disabled = false;
          return;
        }

        statusEl.textContent = 'å‘å¸ƒæˆåŠŸï¼3 ç§’åè·³è½¬åˆ°é¦–é¡µâ€¦';
        form.reset();
        mediaList.length = 0;
        renderMediaList();

        setTimeout(() => {
          window.location.href = '/';
        }, 3000);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œç¨åå†è¯•';
        submitBtn.disabled = false;
      }
    });

    // åˆå§‹æ¸²æŸ“åª’ä½“åˆ—è¡¨
    renderMediaList();
  </script>
</body>

</html>