<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>Todo List - MongoDB 版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 12px;
      background: #0f172a;
      color: #e5e7eb;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
    }

    a {
      color: #38bdf8;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #back-link {
      text-align: center;
      margin-bottom: 20px;
      font-size: 14px;
      color: #9ca3af;
    }

    #new-todo-form {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    #new-todo-form input {
      flex: 1;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    #new-todo-form button {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #38bdf8, #6366f1);
      color: white;
      font-size: 14px;
    }

    ul {
      list-style: none;
      padding: 0;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.9);
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
    }

    li:last-child {
      border-bottom: none;
    }

    .todo-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .done {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .delete-btn {
      border: none;
      background: #f97373;
      color: white;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 999px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h1>我的 Todo List</h1>
  <div id="back-link">
    <a href="/">← 回到博客首页</a>
  </div>

  <form id="new-todo-form">
    <input id="title-input" type="text" placeholder="输入待办事项，回车或点击添加" />
    <button type="submit">添加</button>
  </form>

  <ul id="todo-list"></ul>

  <script>
    const API_BASE = '/api';


    const todoListEl = document.getElementById('todo-list');
    const formEl = document.getElementById('new-todo-form');
    const titleInputEl = document.getElementById('title-input');

    // 渲染一条 todo
    function renderTodoItem(todo) {
      const li = document.createElement('li');
      li.dataset.id = todo._id;

      const leftDiv = document.createElement('div');
      leftDiv.className = 'todo-left';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = todo.done;

      const span = document.createElement('span');
      span.textContent = todo.title;
      if (todo.done) span.classList.add('done');

      leftDiv.appendChild(checkbox);
      leftDiv.appendChild(span);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '删除';
      deleteBtn.className = 'delete-btn';

      li.appendChild(leftDiv);
      li.appendChild(deleteBtn);

      // 事件：切换完成状态
      checkbox.addEventListener('change', async () => {
        try {
          const res = await fetch(`${API_BASE}/todos/${todo._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ done: checkbox.checked })
          });
          const updated = await res.json();
          if (!res.ok) {
            alert(updated.message || '更新失败');
            checkbox.checked = !checkbox.checked;
            return;
          }
          span.classList.toggle('done', updated.done);
        } catch (err) {
          console.error(err);
          alert('网络错误');
          checkbox.checked = !checkbox.checked;
        }
      });

      // 事件：删除
      deleteBtn.addEventListener('click', async () => {
        if (!confirm('确认删除这条 Todo 吗？')) return;
        try {
          const res = await fetch(`${API_BASE}/todos/${todo._id}`, {
            method: 'DELETE'
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.message || '删除失败');
            return;
          }
          li.remove();
        } catch (err) {
          console.error(err);
          alert('网络错误');
        }
      });

      return li;
    }

    // 加载所有 todo
    async function loadTodos() {
      todoListEl.innerHTML = '加载中…';
      try {
        const res = await fetch(`${API_BASE}/todos`);
        const todos = await res.json();
        todoListEl.innerHTML = '';
        todos.forEach(todo => {
          const li = renderTodoItem(todo);
          todoListEl.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        todoListEl.innerHTML = '加载失败';
      }
    }

    // 提交表单：新增 todo
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = titleInputEl.value.trim();
      if (!title) return;

      try {
        const res = await fetch(`${API_BASE}/todos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, done: false })
        });
        const newTodo = await res.json();
        if (!res.ok) {
          alert(newTodo.message || '创建失败');
          return;
        }
        const li = renderTodoItem(newTodo);
        todoListEl.prepend(li);
        titleInputEl.value = '';
      } catch (err) {
        console.error(err);
        alert('网络错误');
      }
    });

    // 页面加载完自动加载 todo 列表
    loadTodos();
  </script>
</body>

</html>